@if (isMedecin()) {
  <div class="medecin-layout">
    <app-medecin-sidebar></app-medecin-sidebar>
    <main class="dashboard-content">
      <ng-container [ngTemplateOutlet]="dossierContent"></ng-container>
    </main>
  </div>
} @else {
  <ng-container [ngTemplateOutlet]="dossierContent"></ng-container>
}
<ng-template #dossierContent>
<div class="dossier">
  <header class="dossier-header">
    <h1>Mon dossier m√©dical</h1>
    <p>Consultez et g√©rez l‚Äôhistorique m√©dical du patient.</p>
  </header>
  @if (isMedecin()) {
    <section class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div>
          <h3>Acc√©der √† un dossier par nom</h3>
          <small>Rechercher un patient par nom/pr√©nom</small>
        </div>
      </div>
      <div style="padding:16px; display:flex; gap:8px; align-items:center;">
        <input [formControl]="patientQuery" (input)="searchPatients()" placeholder="Ex: Riahi Ons" style="flex:1; padding:8px;" />
        <span>Recherche...</span>
      </div>
      @if (searchResults().length > 0) {
        <ul style="padding:0 16px 16px 16px; margin:0; list-style:none;">
          @for (p of searchResults(); track p.id) {
            <li style="padding:8px 0; border-bottom: 1px solid #eee;">
              <a [routerLink]="['/medecin', idMedecin, 'patient', p.id, 'dossier']">
                {{ p.nom }} {{ p.prenom }} ‚Äî {{ p.telephone }}
              </a>
            </li>
          }
        </ul>
      }
    </section>
  }
  @if (!hasAnyData()) {
    <section class="card">
      <div class="card-header">
        <h3>Aucun dossier trouv√©</h3>
      </div>
      <div style="padding:16px">
        Le dossier de ce patient n‚Äôa pas encore √©t√© cr√©√©. Vous pouvez l‚Äôalimenter lors de la prochaine consultation.
      </div>
    </section>
  }

  <section class="card infos-card">
    <div class="card-header">
      <div>
        <h3>Informations principales</h3>
        <small>Groupe sanguin, ant√©c√©dents, traitements en cours‚Ä¶</small>
      </div>
      @if (canEditInfos()) {
        <button class="btn btn-primary" type="button" (click)="saveInfos()" [disabled]="infoForm.invalid">
          Enregistrer
        </button>
      }
    </div>

    <form [formGroup]="infoForm" (ngSubmit)="saveInfos()" class="info-grid">
      <label>
        <span>Groupe sanguin</span>
        <input 
          formControlName="groupe_sanguin" 
          [readonly]="!canEditInfos()" 
          placeholder="Ex : A+, O-" 
          [class.invalid]="isInfoFieldInvalid('groupe_sanguin')"
        />
        @if (isInfoFieldInvalid('groupe_sanguin')) {
          <span class="error-message">Format invalide (Ex: A+, O-, AB+)</span>
        }
      </label>
      <label class="full">
        <span>Ant√©c√©dents m√©dicaux</span>
        <textarea 
          formControlName="antecedents_medicaux" 
          rows="2" 
          [readonly]="!canEditInfos()" 
          placeholder="Historique des pathologies..."
        ></textarea>
        @if (infoForm.get('antecedents_medicaux')?.hasError('maxlength')) {
          <span class="error-message">Texte trop long (max 1000 caract√®res)</span>
        }
      </label>
      <label class="full">
        <span>Traitements en cours</span>
        <textarea 
          formControlName="traitements_en_cours" 
          rows="2" 
          [readonly]="!canEditInfos()" 
          placeholder="Liste des traitements..."
        ></textarea>
         @if (infoForm.get('traitements_en_cours')?.hasError('maxlength')) {
          <span class="error-message">Texte trop long (max 1000 caract√®res)</span>
        }
      </label>
      <label class="full">
        <span>Vaccinations</span>
        <textarea 
          formControlName="vaccinations" 
          rows="2" 
          [readonly]="!canEditInfos()" 
          placeholder="Vaccins r√©alis√©s..."
        ></textarea>
      </label>
      <label class="full">
        <span>Diagnostic</span>
        <textarea 
          formControlName="diagnostic" 
          rows="2" 
          [readonly]="!canEditInfos()" 
          placeholder="Diagnostic principal..."
        ></textarea>
      </label>
    </form>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <h3>Ordonnances</h3>
        <small>Prescriptions et traitements</small>
      </div>
    </div>

    @if (canManageOrdonnances()) {
      @if (!showOrdonnanceForm() && !editingOrdonnanceId()) {
        <div class="add-button-container">
          <button class="btn btn-primary btn-add" type="button" (click)="toggleOrdonnanceForm()">
            ‚ûï Nouvelle ordonnance
          </button>
        </div>
      }
      @if (showOrdonnanceForm() || editingOrdonnanceId()) {
        <div class="form-section-header">
          <h4>‚ûï Nouvelle ordonnance</h4>
          <p>Remplissez le formulaire ci-dessous pour ajouter une nouvelle ordonnance</p>
        </div>
        <form [formGroup]="ordonnanceForm" (ngSubmit)="submitOrdonnance()" class="form-inline">
        <div class="two-cols">
          <label>
            <span>Date</span>
            <input type="date" formControlName="date_ordonnance" />
            @if (ordonnanceForm.get('date_ordonnance')?.invalid && ordonnanceForm.get('date_ordonnance')?.touched) {
              <span class="error-message">Veuillez remplir ce champ</span>
            }
          </label>
          <label>
            <span>M√©dicaments</span>
            <input formControlName="medicaments" placeholder="M√©dicaments prescrits" />
            @if (ordonnanceForm.get('medicaments')?.invalid && ordonnanceForm.get('medicaments')?.touched) {
              <span class="error-message">Veuillez remplir ce champ</span>
            }
          </label>
        </div>
        <label>
          <span>Posologie</span>
          <textarea formControlName="posologie" rows="2" placeholder="Dosage, fr√©quence..."></textarea>
        </label>
        <label>
          <span>Dur√©e du traitement</span>
          <input formControlName="duree_traitement" placeholder="Ex : 7 jours" />
        </label>
        <label>
          <span>Notes</span>
          <textarea formControlName="notes" rows="2" placeholder="Recommandations suppl√©mentaires"></textarea>
        </label>
        <label>
          <span>Lien du document</span>
          <input formControlName="url_document" placeholder="URL du document (optionnel)" />
        </label>
        <div class="actions">
          <button class="btn btn-primary" type="submit">
            @if (editingOrdonnanceId()) { Mettre √† jour } @else { Ajouter l'ordonnance }
          </button>
          <button class="btn btn-tertiary" type="button" (click)="toggleOrdonnanceForm()">Annuler</button>
        </div>
      </form>
      }
    }

    <div class="list-section-header">
      <h4>üìã Ordonnances enregistr√©es</h4>
    </div>
    <div class="list">
      @for (ordo of ordonnances(); track ordo.idOrdonnance) {
        <article class="list-item">
          <header>
            <h4>Ordonnance du {{ ordo.date_ordonnance | date:'mediumDate' }}</h4>
            <span>Dr {{ ordo.medecinPrenom }} {{ ordo.medecinNom }}</span>
          </header>
          <p><strong>M√©dicaments :</strong> {{ ordo.medicaments }}</p>
          @if (ordo.posologie) {
            <p><strong>Posologie :</strong> {{ ordo.posologie }}</p>
          }
          @if (ordo.duree_traitement) {
            <p><strong>Dur√©e :</strong> {{ ordo.duree_traitement }}</p>
          }
          @if (ordo.notes) {
            <p><strong>Notes :</strong> {{ ordo.notes }}</p>
          }
          @if (ordo.url_document) {
            <a [href]="ordo.url_document" target="_blank">Voir l'ordonnance</a>
          }
          @if (canManageOrdonnances()) {
            <div class="item-actions">
              <button class="action-link" type="button" (click)="editOrdonnance(ordo)">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span>Modifier</span>
              </button>
              <button class="action-link danger" type="button" (click)="deleteOrdonnance(ordo)">
                <span class="btn-icon">üóëÔ∏è</span>
                <span>Supprimer</span>
              </button>
            </div>
          }
        </article>
      } @empty {
        <p class="empty">Aucune ordonnance enregistr√©e.</p>
      }
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <h3>Analyses</h3>
        <small>R√©sultats d'analyses et examens</small>
      </div>
    </div>

    @if (canManageAnalyses()) {
      @if (!showAnalyseForm() && !editingAnalyseId()) {
        <div class="add-button-container">
          <button class="btn btn-primary btn-add" type="button" (click)="toggleAnalyseForm()">
            ‚ûï Nouvelle analyse
          </button>
        </div>
      }
      @if (showAnalyseForm() || editingAnalyseId()) {
        <div class="form-section-header">
          <h4>‚ûï Nouvelle analyse</h4>
          <p>Remplissez le formulaire ci-dessous pour ajouter une nouvelle analyse</p>
        </div>
        <form [formGroup]="analyseForm" (ngSubmit)="submitAnalyse()" class="form-inline">
        <div class="two-cols">
          <label>
            <span>Type d'analyse</span>
            <input formControlName="type_analyse" placeholder="Ex : Bilan sanguin" />
            @if (analyseForm.get('type_analyse')?.invalid && analyseForm.get('type_analyse')?.touched) {
              <span class="error-message">Veuillez remplir ce champ</span>
            }
          </label>
          <label>
            <span>Date</span>
            <input type="date" formControlName="date_analyse" />
            @if (analyseForm.get('date_analyse')?.invalid && analyseForm.get('date_analyse')?.touched) {
              <span class="error-message">Veuillez remplir ce champ</span>
            }
          </label>
        </div>
        <label>
          <span>R√©sultats</span>
          <textarea formControlName="resultats" rows="2" placeholder="Synth√®se des r√©sultats"></textarea>
        </label>
        <label>
          <span>Laboratoire</span>
          <input formControlName="laboratoire" placeholder="Laboratoire / √©tablissement" />
        </label>
        <label>
          <span>Notes</span>
          <textarea formControlName="notes" rows="2" placeholder="Commentaires du m√©decin"></textarea>
        </label>
        <label>
          <span>Lien du document</span>
          <input formControlName="url_document" placeholder="URL du compte-rendu (optionnel)" />
        </label>
        <div class="actions">
          <button class="btn btn-primary" type="submit">
            @if (editingAnalyseId()) { Mettre √† jour } @else { Ajouter l'analyse }
          </button>
          <button class="btn btn-tertiary" type="button" (click)="toggleAnalyseForm()">Annuler</button>
        </div>
      </form>
      }
    }

    <div class="list-section-header">
      <h4>üìã Analyses enregistr√©es</h4>
    </div>
    <div class="list">
      @for (analyse of analyses(); track analyse.idAnalyse) {
        <article class="list-item">
          <header>
            <h4>{{ analyse.type_analyse }}</h4>
            <span>{{ analyse.date_analyse | date:'mediumDate' }}</span>
          </header>
          <p><strong>R√©sultats :</strong> {{ analyse.resultats || '‚Äî' }}</p>
          <p><strong>Laboratoire :</strong> {{ analyse.laboratoire || '‚Äî' }}</p>
          <p><strong>M√©decin :</strong> {{ analyse.medecinPrenom }} {{ analyse.medecinNom }}</p>
          @if (analyse.notes) {
            <p><strong>Notes :</strong> {{ analyse.notes }}</p>
          }
          @if (analyse.url_document) {
            <a [href]="analyse.url_document" target="_blank">Voir le document</a>
          }
          @if (canManageAnalyses()) {
            <div class="item-actions">
              <button class="action-link" type="button" (click)="editAnalyse(analyse)">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span>Modifier</span>
              </button>
              <button class="action-link danger" type="button" (click)="deleteAnalyse(analyse)">
                <span class="btn-icon">üóëÔ∏è</span>
                <span>Supprimer</span>
              </button>
            </div>
          }
        </article>
      } @empty {
        <p class="empty">Aucune analyse enregistr√©e.</p>
      }
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <h3>Notes m√©dicales</h3>
        <small>Comptes rendus et suivi des consultations</small>
      </div>
    </div>

      @if (canManageNotes()) {
        @if (!showNoteForm() && !editingNoteId()) {
          <div class="add-button-container">
            <button class="btn btn-primary btn-add" type="button" (click)="toggleNoteForm()">
              ‚ûï Nouvelle note m√©dicale
            </button>
          </div>
        }
        @if (showNoteForm() || editingNoteId()) {
          <div class="form-section-header">
            <h4>‚ûï Nouvelle note m√©dicale</h4>
            <p>Remplissez le formulaire ci-dessous pour ajouter une nouvelle note</p>
          </div>
          <form [formGroup]="noteForm" (ngSubmit)="submitNote()" class="form-inline">
            <label>
              <span>Type de note</span>
              <input formControlName="type_note" placeholder="Ex : Consultation, Suivi..." />
            </label>
            <label>
              <span>Contenu</span>
              <textarea formControlName="contenu_note" rows="3" placeholder="R√©sum√© de la consultation"></textarea>
              @if (noteForm.get('contenu_note')?.invalid && noteForm.get('contenu_note')?.touched) {
                <span class="error-message">Veuillez remplir ce champ</span>
              }
            </label>
            <div class="actions">
              <button class="btn btn-primary" type="submit">
                @if (editingNoteId()) { Mettre √† jour } @else { Ajouter la note }
              </button>
              <button class="btn btn-tertiary" type="button" (click)="toggleNoteForm()">Annuler</button>
            </div>
          </form>
        }
      }

    <div class="list-section-header">
      <h4>üìã Notes m√©dicales enregistr√©es</h4>
    </div>
    <div class="list">
      @for (note of notes(); track note.idNote) {
        <article class="list-item">
          <header>
            <h4>{{ note.type_note }}</h4>
            <span>{{ note.created_at | date:'medium' }}</span>
          </header>
          <p>{{ note.contenu_note }}</p>
          <p class="medecin">Dr {{ note.medecinPrenom }} {{ note.medecinNom }}</p>
          @if (canManageNotes()) {
            <div class="item-actions">
              <button class="action-link" type="button" (click)="editNote(note)">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span>Modifier</span>
              </button>
              <button class="action-link danger" type="button" (click)="deleteNote(note)">
                <span class="btn-icon">üóëÔ∏è</span>
                <span>Supprimer</span>
              </button>
            </div>
          }
        </article>
      } @empty {
        <p class="empty">Aucune note enregistr√©e.</p>
      }
    </div>
  </section>
</div>
</ng-template>
